<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Professional Video Reaction Recorder</title>
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
   
    body {
      font-family: 'Arial', sans-serif;
      text-align: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 10px;
      color: white;
      min-height: 100vh;
      overflow-x: hidden;
    }
   
    .container {
      max-width: 100%;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 15px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
    }
   
    h2 {
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
   
    /* Video Source Selection */
    .video-source-section {
      margin: 20px 0;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      backdrop-filter: blur(5px);
    }
   
    .source-selector {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
   
    .source-option {
      flex: 1;
      min-width: 200px;
      max-width: 250px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid transparent;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }
   
    .source-option:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 255, 255, 0.2);
    }
   
    .source-option.active {
      border-color: #4CAF50;
      background: rgba(76, 175, 80, 0.2);
    }
   
    .source-option h4 {
      margin: 0 0 10px 0;
      font-size: 1.2rem;
    }
   
    .source-option p {
      margin: 0;
      font-size: 0.9rem;
      opacity: 0.8;
    }
   
    /* Camera/Video Source Selection */
    .camera-selector {
      margin: 20px 0;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 15px;
      backdrop-filter: blur(5px);
    }
   
    .camera-selector select {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 15px;
      font-size: 1rem;
      cursor: pointer;
      width: 100%;
      max-width: 300px;
      margin: 10px 0;
    }
   
    .camera-selector select option {
      background: #333;
      color: white;
    }
   
    /* Video container - 9:16 vertical stack */
    #videoContainer {
      position: relative;
      width: 100%;
      max-width: 95vw;
      margin: 20px auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      border-radius: 15px;
      overflow: hidden;
      background: #000;
      display: flex;
      flex-direction: column;
      aspect-ratio: 9 / 16;
      touch-action: none;
    }

    /* Reaction camera - top 30% */
    #reactionOverlay {
      width: 100%;
      height: 30%;
      object-fit: cover;
      border-bottom: 3px solid transparent;
      background: linear-gradient(white, white) padding-box,
                  linear-gradient(to right, #ffcc00, #ff9900, #ff6600) border-box;
      z-index: 10;
      user-select: none;
      -webkit-user-select: none;
    }

    /* Main video - bottom 70% */
    #videoPlayer {
      width: 100%;
      height: 70%;
      object-fit: contain;
      background: #000;
      z-index: 1;
    }

    /* File upload styling */
    .file-upload-container {
      margin: 20px 0;
      position: relative;
    }
   
    #uploadVideo {
      display: none;
    }
   
    .upload-label {
      display: inline-block;
      padding: 15px 30px;
      background: linear-gradient(45deg, #ff6b6b, #ee5a24);
      color: white;
      border-radius: 50px;
      cursor: pointer;
      font-size: clamp(0.9rem, 2.5vw, 1.1rem);
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(238, 90, 36, 0.4);
    }
   
    .upload-label:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(238, 90, 36, 0.6);
    }
   
    .upload-label.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Audio controls */
    .audio-controls {
      margin: 20px 0;
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }
   
    .volume-control {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.1);
      padding: 10px 15px;
      border-radius: 25px;
      backdrop-filter: blur(5px);
      min-width: 200px;
    }
   
    .volume-control label {
      font-weight: bold;
      min-width: 70px;
      font-size: clamp(0.8rem, 2vw, 1rem);
    }
   
    .volume-control input[type="range"] {
      flex: 1;
      height: 8px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      outline: none;
      appearance: none;
    }
   
    .volume-control input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      background: #ff6b6b;
      border-radius: 50%;
      cursor: pointer;
    }

    /* Quality settings */
    .quality-settings {
      margin: 20px 0;
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }
   
    .quality-option {
      background: rgba(255, 255, 255, 0.1);
      padding: 10px 20px;
      border-radius: 20px;
      backdrop-filter: blur(5px);
    }
   
    .quality-option select {
      background: transparent;
      color: white;
      border: none;
      font-size: clamp(0.9rem, 2vw, 1rem);
      cursor: pointer;
      padding: 5px;
    }
   
    .quality-option select option {
      background: #333;
      color: white;
    }

    /* Button styling */
    .controls {
      margin: 20px 0;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
   
    button {
      margin: 5px;
      padding: 12px 20px;
      border: none;
      border-radius: 25px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      cursor: pointer;
      font-size: clamp(0.8rem, 2vw, 1rem);
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      min-width: 120px;
      touch-action: manipulation;
    }
   
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }
   
    button:disabled {
      background: #888;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      opacity: 0.6;
    }
   
    button.recording {
      background: linear-gradient(45deg, #ff4757, #ff3838);
      animation: pulse 1.5s ease-in-out infinite alternate;
    }
   
    @keyframes pulse {
      0% { box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4); }
      100% { box-shadow: 0 8px 30px rgba(255, 71, 87, 0.8); }
    }

    /* Status indicator */
    .status-indicator {
      margin: 15px 0;
      padding: 12px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(5px);
      display: none;
      font-size: clamp(0.8rem, 2vw, 1rem);
    }
   
    .status-indicator.show {
      display: block;
    }
   
    .status-indicator.recording {
      background: rgba(255, 71, 87, 0.2);
      border: 2px solid #ff4757;
    }
   
    .status-indicator.ready {
      background: rgba(46, 213, 115, 0.2);
      border: 2px solid #2ed573;
    }

    /* Preview container */
    #previewContainer {
      margin-top: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 20px;
      backdrop-filter: blur(10px);
    }
   
    #previewVideo {
      width: 100%;
      max-width: 600px;
      border-radius: 10px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }
   
    .hidden { display: none !important; }
   
    .recording-timer {
      font-size: 1.2rem;
      font-weight: bold;
      margin: 10px 0;
      display: none;
    }
   
    .recording-timer.show {
      display: block;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container { padding: 10px; }
      .source-selector { flex-direction: column; align-items: center; }
      .source-option { min-width: 90%; }
      .volume-control { min-width: 180px; padding: 8px 12px; }
      button { min-width: 100px; padding: 10px 15px; }
    }
   
    @media (max-width: 480px) {
      #videoContainer { max-height: 80vh; }
      .volume-control { flex-direction: column; text-align: center; min-width: 150px; }
      .quality-settings { flex-direction: column; align-items: center; }
    }

    /* REMOVED: Landscape warning message */
  </style>
</head>
<body>
  <div class="container">
    <h2>Professional Video Reaction Recorder</h2>

    <!-- Video Source Selection -->
    <div class="video-source-section">
      <h3>Select Video Source</h3>
      <div class="source-selector">
        <div class="source-option" id="fileSourceOption">
          <h4>Upload File</h4>
          <p>Upload a video file from your device</p>
        </div>
        <div class="source-option" id="cameraSourceOption">
          <h4>Camera/Phone</h4>
          <p>Use camera or phone via Iriun Webcam</p>
        </div>
      </div>

      <!-- File Upload -->
      <div class="file-upload-container" id="fileUploadSection" style="display: none;">
        <input type="file" id="uploadVideo" accept="video/*" />
        <label for="uploadVideo" class="upload-label">Choose Video File</label>
      </div>

      <!-- Camera Input Selector -->
      <div class="camera-selector" id="videoInputSection" style="display: none;">
        <h4>Select Video Input</h4>
        <select id="videoInputSelect">
          <option value="">Choose video input...</option>
        </select>
        <button id="refreshInputs">Refresh Inputs</button>
      </div>
    </div>

    <!-- Quality settings -->
    <div class="quality-settings">
      <div class="quality-option">
        <label>Quality: </label>
        <select id="videoQuality">
          <option value="1080p">1080p HD</option>
          <option value="720p" selected>720p (Recommended)</option>
          <option value="480p">480p</option>
        </select>
      </div>
      <div class="quality-option">
        <label>FPS: </label>
        <select id="frameRate">
          <option value="60">60 FPS</option>
          <option value="30" selected>30 FPS</option>
          <option value="24">24 FPS</option>
        </select>
      </div>
    </div>

    <!-- Audio controls -->
    <div class="audio-controls">
      <div class="volume-control">
        <label>Video Audio:</label>
        <input type="range" id="videoVolume" min="0" max="1" step="0.1" value="0.7">
        <span id="videoVolumeValue">70%</span>
      </div>
      <div class="volume-control">
        <label>Mic Audio:</label>
        <input type="range" id="cameraVolume" min="0" max="1" step="0.1" value="0.8">
        <span id="cameraVolumeValue">80%</span>
      </div>
    </div>

    <!-- Status & Timer -->
    <div id="statusIndicator" class="status-indicator">
      <strong>Status:</strong> <span id="statusText">Select a video source to begin</span>
    </div>
    <div id="recordingTimer" class="recording-timer">
      Recording: <span id="timerDisplay">00:00</span>
    </div>

    <!-- Video Stack: Camera on Top, Main Video Below -->
    <div id="videoContainer">
      <video id="reactionOverlay" autoplay muted playsinline></video>
      <video id="videoPlayer" crossorigin="anonymous" playsinline></video>
    </div>

    <!-- Controls -->
    <div class="controls" id="mainControls">
      <button id="startCamera">Enable Camera</button>
      <button id="switchCamera">Switch Camera</button>
      <button id="pauseVideo" class="hidden">Pause</button>
      <button id="startRecording">Start Recording</button>
      <button id="stopRecording" disabled>Stop</button>
    </div>

    <!-- Preview -->
    <div id="previewContainer" class="hidden">
      <h3>Preview Recording</h3>
      <video id="previewVideo" controls playsinline></video>
      <div class="controls">
        <button id="downloadRecording">Download</button>
        <button id="discardRecording">Try Again</button>
      </div>
    </div>
  </div>

  <script>
    // DOM Elements
    const videoPlayer = document.getElementById("videoPlayer");
    const reactionOverlay = document.getElementById("reactionOverlay");
    const startCameraBtn = document.getElementById("startCamera");
    const switchCameraBtn = document.getElementById("switchCamera");
    const pauseVideoBtn = document.getElementById("pauseVideo");
    const startRecordingBtn = document.getElementById("startRecording");
    const stopRecordingBtn = document.getElementById("stopRecording");
    const previewContainer = document.getElementById("previewContainer");
    const previewVideo = document.getElementById("previewVideo");
    const downloadRecordingBtn = document.getElementById("downloadRecording");
    const discardRecordingBtn = document.getElementById("discardRecording");
    const statusIndicator = document.getElementById("statusIndicator");
    const statusText = document.getElementById("statusText");
    const videoVolumeSlider = document.getElementById("videoVolume");
    const cameraVolumeSlider = document.getElementById("cameraVolume");
    const videoVolumeValue = document.getElementById("videoVolumeValue");
    const cameraVolumeValue = document.getElementById("cameraVolumeValue");
    const videoQuality = document.getElementById("videoQuality");
    const frameRate = document.getElementById("frameRate");
    const mainControls = document.getElementById("mainControls");
    const recordingTimer = document.getElementById("recordingTimer");
    const timerDisplay = document.getElementById("timerDisplay");

    // Source Elements
    const fileSourceOption = document.getElementById("fileSourceOption");
    const cameraSourceOption = document.getElementById("cameraSourceOption");
    const fileUploadSection = document.getElementById("fileUploadSection");
    const videoInputSection = document.getElementById("videoInputSection");
    const videoInputSelect = document.getElementById("videoInputSelect");
    const refreshInputsBtn = document.getElementById("refreshInputs");

    // State
    let cameraStream = null;
    let currentFacing = "user";
    let mediaRecorder = null;
    let recordedChunks = [];
    let isRecording = false;
    let canvas = null;
    let audioContext = null;
    let videoAudioGain = null;
    let cameraAudioGain = null;
    let mixedAudio = null;
    let selectedVideoSource = null;
    let availableVideoInputs = [];
    let recordingStartTime = 0;
    let timerInterval = null;
    let isVideoPaused = false;

    // Update Status
    function updateStatus(message, type = 'ready') {
      statusText.textContent = message;
      statusIndicator.className = `status-indicator show ${type}`;
    }

    // Timer
    function updateTimer() {
      if (!isRecording) return;
      const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
      const seconds = (elapsed % 60).toString().padStart(2, '0');
      timerDisplay.textContent = `${minutes}:${seconds}`;
    }

    // Source Selection
    fileSourceOption.addEventListener('click', () => selectVideoSource('file'));
    cameraSourceOption.addEventListener('click', () => selectVideoSource('camera'));

    function selectVideoSource(source) {
      selectedVideoSource = source;
      document.querySelectorAll('.source-option').forEach(el => el.classList.remove('active'));
      
      if (source === 'file') {
        fileSourceOption.classList.add('active');
        fileUploadSection.style.display = 'block';
        videoInputSection.style.display = 'none';
        updateStatus('Upload a video file to continue', 'ready');
        if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
        videoPlayer.srcObject = null;
      } else {
        cameraSourceOption.classList.add('active');
        fileUploadSection.style.display = 'none';
        videoInputSection.style.display = 'block';
        updateStatus('Select a video input source', 'ready');
        videoPlayer.src = '';
        document.getElementById('uploadVideo').value = '';
        loadVideoInputs();
      }
    }

    // Load Video Inputs
    async function loadVideoInputs() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        stream.getTracks().forEach(t => t.stop());
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoInputs = devices.filter(d => d.kind === 'videoinput');
        availableVideoInputs = videoInputs;

        videoInputSelect.innerHTML = '<option value="">Choose video input...</option>';
        videoInputs.forEach((d, i) => {
          const opt = document.createElement('option');
          opt.value = d.deviceId;
          opt.textContent = d.label || `Camera ${i + 1}`;
          videoInputSelect.appendChild(opt);
        });
        updateStatus(`Found ${videoInputs.length} input(s)`, 'ready');
      } catch (e) {
        updateStatus('Camera access denied', 'recording');
      }
    }

    refreshInputsBtn.addEventListener('click', loadVideoInputs);

    // Video Input Change
    videoInputSelect.addEventListener('change', async (e) => {
      const id = e.target.value;
      if (!id) return;
      updateStatus('Starting video...', 'recording');
      if (cameraStream) cameraStream.getTracks().forEach(t => t.stop());
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { deviceId: { exact: id }, width: { ideal: 1920 }, height: { ideal: 1080 } }
      });
      videoPlayer.srcObject = stream;
      cameraStream = stream;
      videoPlayer.addEventListener('loadedmetadata', setupCanvas, { once: true });
      pauseVideoBtn.classList.remove("hidden");
      updateStatus('Video ready!', 'ready');
    });

    // File Upload
    document.getElementById("uploadVideo").addEventListener("change", (e) => {
      if (selectedVideoSource !== 'file') return;
      const file = e.target.files[0];
      if (file && file.type.startsWith("video/")) {
        const url = URL.createObjectURL(file);
        videoPlayer.src = url;
        videoPlayer.srcObject = null;
        videoPlayer.load();
        pauseVideoBtn.classList.remove("hidden");
        updateStatus("Video loaded!", "ready");
      }
    });

    // Setup Canvas
    function setupCanvas() {
      const quality = videoQuality.value;
      const aspect = videoPlayer.videoWidth / videoPlayer.videoHeight;
      let h, w;
      switch(quality) {
        case '1080p': h = 1080; break;
        case '720p': h = 720; break;
        case '480p': h = 480; break;
        default: h = videoPlayer.videoHeight;
      }
      w = Math.round(h * aspect);
      canvas = document.createElement("canvas");
      canvas.width = w; canvas.height = h;
      updateStatus(`Ready (${w}x${h})`, "ready");
    }

    videoPlayer.addEventListener("loadedmetadata", setupCanvas);

    // Volume Sliders
    videoVolumeSlider.addEventListener('input', () => {
      const v = Math.round(videoVolumeSlider.value * 100);
      videoVolumeValue.textContent = `${v}%`;
      videoPlayer.volume = videoVolumeSlider.value;
      if (videoAudioGain) videoAudioGain.gain.value = videoVolumeSlider.value;
    });

    cameraVolumeSlider.addEventListener('input', () => {
      const v = Math.round(cameraVolumeSlider.value * 100);
      cameraVolumeValue.textContent = `${v}%`;
      if (cameraAudioGain) cameraAudioGain.gain.value = cameraVolumeSlider.value;
    });

    // Camera
    async function startCamera() {
      if (reactionOverlay.srcObject) reactionOverlay.srcObject.getTracks().forEach(t => t.stop());
      updateStatus("Starting camera...", "recording");
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: currentFacing },
          audio: { echoCancellation: true, noiseSuppression: true }
        });
        reactionOverlay.srcObject = stream;
        startCameraBtn.textContent = "Camera Ready";
        startCameraBtn.disabled = true;
        updateStatus("Camera ready!", "ready");
      } catch (e) {
        updateStatus("Camera failed", "recording");
        alert("Allow camera & mic access.");
      }
    }

    startCameraBtn.addEventListener("click", startCamera);
    switchCameraBtn.addEventListener("click", () => {
      currentFacing = currentFacing === "user" ? "environment" : "user";
      startCamera();
    });

    // Pause
    pauseVideoBtn.addEventListener("click", () => {
      if (videoPlayer.paused) {
        videoPlayer.play();
        pauseVideoBtn.textContent = "Pause";
        isVideoPaused = false;
      } else {
        videoPlayer.pause();
        pauseVideoBtn.textContent = "Play";
        isVideoPaused = true;
      }
    });

    // Recording
    async function startRecording() {
      if (!reactionOverlay.srcObject) return alert("Enable camera first");
      if (selectedVideoSource === 'file' && !videoPlayer.src) return alert("Upload video");
      if (selectedVideoSource === 'camera' && !videoPlayer.srcObject) return alert("Select input");
      if (!canvas) return alert("Wait for video load");

      recordedChunks = [];
      startRecordingBtn.textContent = "Recording...";
      startRecordingBtn.classList.add("recording");
      startRecordingBtn.disabled = true;
      stopRecordingBtn.disabled = false;
      recordingTimer.classList.add("show");
      recordingStartTime = Date.now();
      timerInterval = setInterval(updateTimer, 1000);
      updateTimer();
      updateStatus("Recording...", "recording");

      const ctx = canvas.getContext("2d");
      const fps = parseInt(frameRate.value);

      function drawFrame() {
        if (!isRecording) return;
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const topH = canvas.height * 0.3;
        const botH = canvas.height * 0.7;

        if (reactionOverlay.readyState >= 2) {
          ctx.drawImage(reactionOverlay, 0, 0, canvas.width, topH);
          const grad = ctx.createLinearGradient(0, topH - 3, 0, topH);
          grad.addColorStop(0, '#ffcc00'); grad.addColorStop(0.5, '#ff9900'); grad.addColorStop(1, '#ff6600');
          ctx.strokeStyle = grad; ctx.lineWidth = 6;
          ctx.beginPath(); ctx.moveTo(0, topH); ctx.lineTo(canvas.width, topH); ctx.stroke();
        }

        if (videoPlayer.readyState >= 2) {
          ctx.drawImage(videoPlayer, 0, topH, canvas.width, botH);
        }

        if (isRecording) setTimeout(() => requestAnimationFrame(drawFrame), 1000 / fps);
      }

      // Audio Setup
      audioContext = new AudioContext();
      let videoSource = selectedVideoSource === 'file' ?
        audioContext.createMediaElementSource(videoPlayer) :
        audioContext.createMediaStreamSource(videoPlayer.srcObject);

      const camSource = audioContext.createMediaStreamSource(reactionOverlay.srcObject);
      videoAudioGain = audioContext.createGain();
      cameraAudioGain = audioContext.createGain();
      videoAudioGain.gain.value = videoVolumeSlider.value;
      cameraAudioGain.gain.value = cameraVolumeSlider.value;

      const comp = audioContext.createDynamicsCompressor();
      comp.threshold.value = -24; comp.knee.value = 30; comp.ratio.value = 12;
      comp.attack.value = 0.003; comp.release.value = 0.25;

      mixedAudio = audioContext.createMediaStreamDestination();

      videoSource.connect(videoAudioGain).connect(comp);
      camSource.connect(cameraAudioGain).connect(comp);
      comp.connect(mixedAudio);

      const finalStream = new MediaStream([canvas.captureStream(fps).getVideoTracks()[0]]);
      if (mixedAudio.stream.getAudioTracks().length) finalStream.addTrack(mixedAudio.stream.getAudioTracks()[0]);

      const options = MediaRecorder.isTypeSupported('video/webm; codecs=vp9,opus') ? 
        { mimeType: 'video/webm; codecs=vp9,opus', videoBitsPerSecond: 8000000 } :
        { mimeType: 'video/webm', videoBitsPerSecond: 3000000 };

      mediaRecorder = new MediaRecorder(finalStream, options);
      mediaRecorder.ondataavailable = e => e.data.size > 0 && recordedChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        previewVideo.src = URL.createObjectURL(blob);
        previewContainer.classList.remove("hidden");
        updateStatus("Done! Preview below.", "ready");
        resetRecordingUI();
        audioContext.close();
      };

      isRecording = true;
      if (selectedVideoSource === 'file') videoPlayer.play();
      mediaRecorder.start(100);
      drawFrame();
    }

    function stopRecording() {
      if (mediaRecorder && isRecording) {
        isRecording = false;
        mediaRecorder.stop();
      }
    }

    function resetRecordingUI() {
      startRecordingBtn.textContent = "Start Recording";
      startRecordingBtn.classList.remove("recording");
      startRecordingBtn.disabled = false;
      stopRecordingBtn.disabled = true;
      recordingTimer.classList.remove("show");
      if (timerInterval) clearInterval(timerInterval);
    }

    startRecordingBtn.addEventListener("click", startRecording);
    stopRecordingBtn.addEventListener("click", stopRecording);

    downloadRecordingBtn.addEventListener("click", () => {
      const a = document.createElement("a");
      a.href = previewVideo.src;
      a.download = `reaction-${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.webm`;
      a.click();
    });

    discardRecordingBtn.addEventListener("click", () => {
      previewContainer.classList.add("hidden");
      recordedChunks = [];
      updateStatus("Ready", "ready");
    });

    updateStatus("Select a video source", "ready");
  </script>
</body>
</html>
